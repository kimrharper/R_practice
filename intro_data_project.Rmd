---
title: "Exploring the BRFSS data"
output: 
  html_document: 
    fig_height: 4
    highlight: pygments
    theme: spacelab
---
__Dataset:__ BRFSS <br><br>
__Source:__ https://www.cdc.gov/brfss/<br><br>
__Summary:__ The data set is a collection of ~400,000 adult interviews across the United States on health related topics. The data is a combination of self-reported answers and reported biometrics. The features are continuous, ordinal, and discrete. Some features have missing values so data preprocessing is essential. Because the participants were selected randomly the sample can be generalized. This data is not from experimental research so while correlation can be inferred causality can not be inferred.<br><br>
__Goals:__ Explore any correlations among gender, weight, and weight.<br><br>


## Part 0: Setup
```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
library(Rgraphviz)
library(knitr)
library(grid)
library(gridExtra)
```

```{r load-data}
load("brfss2013.RData")
```

```{r}
# group and count a feature with discrete values
feature_vcounts <- function(df, f) {
  df %>%
    group_by_at(f) %>%
      count()}

# method for binning values
bin_min_sample <- function(p) {
  n = 10
  a = 10/p
  b = 10/(1-p)
  max(c(a,b))}

# create a new df for simulating binom probability distribution
binom_prob_df <- function(df, f, target) {
  new_df <- feature_vcounts(df,f)
  new_df$n[new_df[f] == target]/sum(new_df$n)}

# filtering df with subgroup value
subgroup_df <- function(df,f, group) {
  filter(df,df[f]==group)}

# calc the vector probability
binom_prob_vec <- function(v, target) {
  sum(v == target)/length(v)}

# sample from df
binom_sample <- function(s,v)
  sample(v, size=s, replace=TRUE)

# create the binomial sample distribution
binom_sample_dist <- function(df,f,target) {
  sample_dist <- c()
  for (i in 1:10001) {
    prob <- binom_prob_vec(binom_sample(100,df[,f]),target)
    sample_dist <- append(sample_dist,prob)}
  return(sample_dist)}

# convert decimal to percent
to_percent <- function(pvalue) {
  paste(round(pvalue*100,digits= 2),"%",sep="")}
```

* * *

## Part 1: Data

Import and filter the data to only include important features. Reduce features to 3 and then clean the data.
```{r error=FALSE, warning=FALSE,results='asis'}
# Import original file:
orig_dim <- dim(brfss2013)

#colnames(brfss2013)

# Select only relevant features:
weight_diabetes <- brfss2013 %>%
   select(sex, X_ageg5yr, weight2,diabete3)

# Clean data:
# 1.Weight strings -> numeric
weight_diabetes$weight2 <- as.numeric(as.character(weight_diabetes$weight2))
new_dim <- dim(weight_diabetes)

# 2. Remove Null Weights and Weights over 400
weight_diabetes <- na.omit(weight_diabetes)
weight_diabetes <- filter(weight_diabetes, weight2 <= 400)

# 3. Remove Diabetes Responses
target <- c("Yes", "No")
weight_diabetes <- filter(weight_diabetes, diabete3 %in% target)

# 4. Add index and reorder
weight_diabetes$index <- seq.int(nrow(weight_diabetes))
weight_diabetes <- weight_diabetes[c(4,3,1,2)]
clean_dim <- dim(weight_diabetes)

# Show data:
kable(head(weight_diabetes,n=5), caption="Diabetes Data Set",padding=0, format = "markdown",align="l")
```
__Original dimensions:__ <br>[`r orig_dim[1]`] x [`r orig_dim[2]`]<br>
__Reduced dimensions:__ <br> [`r new_dim[1]`] x [`r new_dim[2]`]<br>
__After cleaning:__ <br>[`r clean_dim[1]`] x [`r clean_dim[2]`]

<br>

* * *

## Part 2: Research questions

### **Research quesion 1:**<br>
##### Is there any correlation among sex, weight, and age? (vars: sex, weight2, X_ageg5yr)<br>
Because gender is a key variable in biometrics, it is important to explore whether gender might correllate to other variables. In this case, we are looking at whether or not sex correllates with weight.<br>

### **Research question 2:**<br>
#### Do weight and gender correlate with diabetes? How? (vars: sex, weight2, diabete3)<br>
The goal of this exploratory project is to determine whether or not weight/gender correlate with diabetes. Knowledge of any correlation could be helpful with regards to informing patients of their likelihood of having diabetes based on their gender and weight.<br>


### **Research question 3:**<br>
#### What is the liklihood that a participant reports having diabetes given that they are male and weigh 200 lbs or more (given the sample data)? (vars: sex, weight2, diabete3)<br>
Knowing the liklihood of having a positive diagnosis for diabetes can be valuable for both researchers and patients. We will look at the example scenario and determine what the likelihood is for a male who weighs more than 200 lbs to report having diabetes. 
<br>

* * *

## Part 3: Exploratory data analysis

### **Research question 1:**
_Weight2_ is continuous  so it is important to first check the distribution of the data. _Sex_ is binary categorical so we will visualize it's distribution with a bar plot.<br>

```{r fig.width=12, fig.height=3, error=FALSE, warning=FALSE, message=FALSE}
centered <- theme(plot.title = element_text(hjust = 0.5))
hist_weight <- ggplot(data=weight_diabetes,aes(weight2,  fill=weight2))+
  geom_histogram(fill='salmon',color='white') + ggtitle("Histogram [Weight]") + centered
weight_diabetes$log_weight <- log(weight_diabetes$weight2)
hist_log_weight <- ggplot(data=weight_diabetes,aes(log_weight, fill=log_weight))+
  geom_histogram(fill='mediumturquoise',color='white') + ggtitle("Histogram [Log_Weight]") + centered
grid.arrange(hist_weight, hist_log_weight, ncol = 2)
```
<br>For _Weight2_, the distribution is right skewed while the log of _Weight2_ is nearly normal.
<br>

```{r fig.width=4, fig.height=3, error=FALSE, warning=FALSE, message=FALSE}

gender_count <- ggplot(data=weight_diabetes,aes(sex, fill = sex))+
  geom_bar(color='white') + ggtitle("Gender") + centered 
gender_count
```
<br>There are more female participants than male participants.

<br>
```{r fig.width=12, fig.height=3, error=FALSE, warning=FALSE, message=FALSE}
age_count <- ggplot(data=weight_diabetes,aes(X_ageg5yr)) +
  geom_bar(fill='salmon',color='white') + ggtitle("Age") + centered
age_count
```

<br>

```{r fig.width=12, fig.height=3, error=FALSE, warning=FALSE, message=FALSE}
p<-ggplot(weight_diabetes, aes(x=X_ageg5yr,y=weight2, color=sex)) +
  geom_boxplot()
p
```

### **Research question 2:**



### **Research question 3:**
```{r fig.width=12, fig.height=3, warning=FALSE}
sex_male_distribution <- binom_sample_dist(weight_diabetes,"sex","Male")

male_plot<-ggplot()+
  aes(x=sex_male_distribution)+
  geom_bar(fill='salmon',color='white') + ggtitle("Female - Binom Distribution") + centered

gp_male <- binom_prob_vec(weight_diabetes$sex,"Male")

sex_female_distribution <- binom_sample_dist(weight_diabetes,"sex","Female")

female_plot<-ggplot()+
  aes(x=sex_female_distribution)+
  geom_bar(fill='mediumturquoise',color='white') + ggtitle("Male - Binomial Distribution") + centered

gp_female <- binom_prob_vec(weight_diabetes$sex,"Female")


grid.arrange(male_plot, female_plot, ncol = 2)
```
<br> For _Sex_, the probability of the participant being male is __`r to_percent(gp_male)`__ <br>
<br> The probability of the participant being female is __`r to_percent(gp_female)`__ <br>

```{r fig.width=12, fig.height=3, warning=FALSE}



diabetes_yes_distribution <- binom_sample_dist(weight_diabetes,"diabete3","Yes")
yes_plot<- ggplot()+
  aes(x=diabetes_yes_distribution)+
  geom_bar(fill='salmon',color='white') + ggtitle("Yes - Binom Dist") + centered
dp_yes <- binom_prob_vec(weight_diabetes$diabete3,"Yes")


diabetes_no_distribution <- binom_sample_dist(weight_diabetes,"diabete3","No")
no_plot<- ggplot()+
  aes(x=diabetes_no_distribution)+
  geom_bar(fill='mediumturquoise',color='white') + ggtitle("No - Binom Dist") + centered
dp_no <- binom_prob_vec(weight_diabetes$diabete3,"No")


grid.arrange(yes_plot, no_plot, ncol = 2)
```

<br>For 'Diabete3', the probability of the participant reporting diabetes is low at around __`r to_percent(dp_yes)`__<br>
The probability that a participant will report that they do not have diabetes is around __`r to_percent(dp_no)`__<br>

```{r warning=FALSE}
# probability that participant is 200 lbs or more using right tailed distribution
sd_weight <- sd(weight_diabetes$weight2)
mean_weight <- mean(weight_diabetes$weight2)
z <- (200-mean_weight)/sd_weight
righttailed <-1-pnorm(z)

# probability that participant is 200 lbs or more using lognormed distribution
sd_weight <- sd(weight_diabetes$log_weight)
mean_weight <- mean(weight_diabetes$log_weight)
z <- (log(200)-mean_weight)/sd_weight
1-pnorm(z)

# probability that participant is 200 lbs or more
pvalue=1-exp(pnorm(log(200),mean_weight,sd_weight, log=TRUE))
pvalue

# percentage of participants who weigh 200 or more lbs vs those who are under 200 lbs
weight_diabetes$heavy <- ifelse(weight_diabetes$weight2 < 200,"not_heavy","heavy")
actual <- binom_prob_vec(weight_diabetes$heavy,"heavy")
```
The probability that a participant is heavy is based on lognormed z-score is  __`r to_percent(pvalue)`__. The right-tailed z-score estimate is __`r to_percent(righttailed)`__. The actual percentage is __`r to_percent(actual)`__ 
<br>

```{r}
#gp_male
#gp_female

#dp_no
#dp_yes

male_diabetes_prob <- binom_prob_vec(subgroup_df(weight_diabetes,'sex','Male')$diabete3,"Yes")
female_diabetes_prob <- binom_prob_vec(subgroup_df(weight_diabetes,'sex','Female')$diabete3,"Yes")
#female_diabetes_prob
#male_diabetes_prob
```



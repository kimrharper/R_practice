---
title: "Exploring the BRFSS data"
output: 
  html_document: 
    fig_height: 4
    highlight: pygments
    theme: spacelab
---

<br>

## Part 0: Setup

#### Load packages

```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
library(Rgraphviz)
library(knitr)
library(grid)
```

#### Load data

Make sure your data and R Markdown files are in the same directory. When loaded
your data file will be called `brfss2013`. Delete this note when before you submit 
your work. 

```{r load-data}
load("brfss2013.RData")
```

Functions for analysis:
```{r}
feature_vcounts <- function(df, f) {
  df %>%
    group_by_at(f) %>%
      count()
}

bin_min_sample <- function(p) {
  n = 10
  a = 10/p
  b = 10/(1-p)
  max(c(a,b))
}

binom_prob_df <- function(df, f, target) {
  new_df <- feature_vcounts(df,f)
  new_df$n[new_df[f] == target]/sum(new_df$n)
}

binom_prob_vec <- function(v, target) {
  sum(v == target)/length(v)
}

binom_sample <- function(s,v)
  sample(v, size=s, replace=TRUE)

binom_sample_dist <- function(df,f,target) {
  sample_dist <- c()
  for (i in 1:10001) {
    prob <- binom_prob_vec(binom_sample(100,df[,f]),target)
    sample_dist <- append(sample_dist,prob)
  }
  return(sample_dist)
}

to_percent <- function(pvalue) {
  paste(round(pvalue*100,digits= 2),"%",sep="")
}
```

* * *

## Part 1: Data

Import and filter the data to only include important features. Reduce features to 3 and then clean the data.

```{r error=FALSE, warning=FALSE,results='asis'}
# Import original file:
orig_dim <- dim(brfss2013)

# Select only relevant features:
weight_diabetes <- brfss2013 %>%
   select(sex, weight2,diabete3)

# Clean data:
# 1.Weight strings -> numeric
weight_diabetes$weight2 <- as.numeric(as.character(weight_diabetes$weight2))
new_dim <- dim(weight_diabetes)

# 2. Remove Null Weights and Weights over 400
weight_diabetes <- na.omit(weight_diabetes)
weight_diabetes <- filter(weight_diabetes, weight2 <= 400)

# 3. Remove Diabetes Responses
target <- c("Yes", "No")
weight_diabetes <- filter(weight_diabetes, diabete3 %in% target)

# 4. Add index and reorder
weight_diabetes$index <- seq.int(nrow(weight_diabetes))
weight_diabetes <- weight_diabetes[c(4,3,1,2)]
clean_dim <- dim(weight_diabetes)

# Show data:
kable(head(weight_diabetes,n=5), caption="Diabetes Data Set",padding=0, format = "markdown",align="l")
```
__Original dimensions:__ <br>[`r orig_dim[1]`] x [`r orig_dim[2]`]<br>
__Reduced dimensions:__ <br> [`r new_dim[1]`] x [`r new_dim[2]`]<br>
__After cleaning:__ <br>[`r clean_dim[1]`] x [`r clean_dim[2]`]


<br>




* * *

## Part 2: Research questions

### **Research quesion 1:**<br>
##### What are the distributions of the updated data set: sex, weight, diabete3?<br><br>

#### Weight2: (Continuous)

```{r error=FALSE, warning=FALSE, message=FALSE}
centered <- theme(plot.title = element_text(hjust = 0.5))
hist_weight <-ggplot(data=weight_diabetes,aes(weight2))+
  geom_histogram()
hist_weight + ggtitle("Histogram [Weight]") + centered
weight_diabetes$log_weight <- log(weight_diabetes$weight2)
hist_log_weight <- ggplot(data=weight_diabetes,aes(log_weight))+
  geom_histogram()
hist_log_weight + ggtitle("Histogram [Log_Weight]") + centered

head(weight_diabetes$log_weight, n=10)

head(weight_diabetes$weight2,n=10)


```
For 'Weight2', the distribution is right skewed while the log of Weight 2 appears to be nearly normal.
<br>

#### Sex: (Discrete-Binary)
```{r warning=FALSE}
sex_male_distribution <- binom_sample_dist(weight_diabetes,"sex","Male")

ggplot()+
  aes(x=sex_male_distribution)+
  geom_bar(width = 0.05)

gp_male <- binom_prob_vec(weight_diabetes$sex,"Male")
```
<br> For 'Sex', the probability of the participant being male is slightly higher at __`r to_percent(gp_male)`__ <br>


```{r warning=FALSE}
sex_female_distribution <- binom_sample_dist(weight_diabetes,"sex","Female")

ggplot()+
  aes(x=sex_female_distribution)+
  geom_bar(width = 0.05)

gp_female <- binom_prob_vec(weight_diabetes$sex,"Female")
```
<br> For 'Sex', the probability of the participant being female is slightly lower at __`r to_percent(gp_female)`__ <br>

#### Diabete3: (Discrete-Binary)
```{r warning=FALSE}
diabetes_yes_distribution <- binom_sample_dist(weight_diabetes,"diabete3","Yes")

ggplot()+
  aes(x=diabetes_yes_distribution)+
  geom_bar(width = 0.05)

dp_yes <- binom_prob_vec(weight_diabetes$diabete3,"Yes")
```

<br>For 'Diabete3', the probability of the participant having diabetes is low at around __`r to_percent(dp_yes)`__<br>

```{r warning=FALSE}
diabetes_no_distribution <- binom_sample_dist(weight_diabetes,"diabete3","No")

ggplot()+
  aes(x=diabetes_no_distribution)+
  geom_bar(width = 0.05)

dp_no <- binom_prob_vec(weight_diabetes$diabete3,"No")

```

For 'Diabete3', the probability of the participant not having diabetes is high at around __`r to_percent(dp_no)`__<br>

### **Research question 2:**<br>
#### What is the probability that a participant is heavy (weight > 200)?<br><br>

```{r warning=FALSE}
# probability that participant is 200 lbs or more using right tailed distribution
sd_weight <- sd(weight_diabetes$weight2)
mean_weight <- mean(weight_diabetes$weight2)
z <- (200-mean_weight)/sd_weight
righttailed <-1-pnorm(z)

# probability that participant is 200 lbs or more using lognormed distribution
sd_weight <- sd(weight_diabetes$log_weight)
mean_weight <- mean(weight_diabetes$log_weight)
z <- (log(200)-mean_weight)/sd_weight
1-pnorm(z)

# probability that participant is 200 lbs or more
pvalue=1-exp(pnorm(log(200),mean_weight,sd_weight, log=TRUE))
pvalue

# percentage of heavy vs not heavy
weight_diabetes$heavy <- ifelse(weight_diabetes$weight2 < 200,"not_heavy","heavy")
actual <- binom_prob_vec(weight_diabetes$heavy,"heavy")
```
#### The probability that a participant is heavy is based on lognormed z-score is  __`r pvalue`__. The actual percentage is __`r actual`__ 
<br>

### **Research question 3:**<br>
#### What is the probability that a participant has diabetes if they are male and heavy (weight > 200)?
<br>





* * *

## Part 3: Exploratory data analysis

NOTE: Insert code chunks as needed by clicking on the "Insert a new code chunk" 
button (green button with orange arrow) above. Make sure that your code is visible
in the project you submit. Delete this note when before you submit your work.

**Research quesion 1:**

```{r}

```



**Research quesion 2:**

```{r}

```



**Research quesion 3:**

```{r}

```


## Part 4: Conclusion

__Assumptions Made:__ 

(1) _The feature 'diabete3' is a survey question asking the participant whether or not they know they have diabetes. I will be interpreting the response of this survey question to be either a positive or negative diagnosis on diabetes, but in actuality data will reflect the respondants' awareness of whether or not they have diabetes._ <br><br>

(2) _The feature 'diabete3' has other options besides Yes/No. I removed these other results so as to limit the discrete options, but in actuality other the two other responses may also be important for consideration._

```{r}
# Example code by: http://www.harrysurden.com/wordpress/archives/292
# R Conditional Probability Tree Diagram
 
# The Rgraphviz graphing package must be installed to do this
require("Rgraphviz")
 
# Change the three variables below to match your actual values
# These are the values that you can change for your own probability tree
# From these three values, other probabilities (e.g. prob(b)) will be calculated 
 
# Probability of a
a<-.01
 
# Probability (b | a)
bGivena<-.99
 
# Probability (b | Â¬a)
bGivenNota<-.10
 
###################### Everything below here will be calculated
 
# Calculate the rest of the values based upon the 3 variables above
notbGivena<-1-bGivena
notA<-1-a
notbGivenNota<-1-bGivenNota
 
#Joint Probabilities of a and B, a and notb, nota and b, nota and notb
aANDb<-a*bGivena
aANDnotb<-a*notbGivena
notaANDb <- notA*bGivenNota
notaANDnotb <- notA*notbGivenNota
 
# Probability of B
b<- aANDb + notaANDb
notB <- 1-b
 
# Bayes theorum - probabiliyt of A | B
# (a | b) = Prob (a AND b) / prob (b)
aGivenb <- aANDb / b
 
# These are the labels of the nodes on the graph
# To signify "Not A" - we use A' or A prime 
 
node1<-"G"
node2<-"W"
node3<-"W'"
node4<-"W&D"
node5<-"W&D'"
node6<-"W'&D"
node7<-"W'&D'"
nodeNames<-c(node1,node2,node3,node4, node5,node6, node7)
 
rEG <- new("graphNEL", nodes=nodeNames, edgemode="directed")

 
# Draw the "lines" or "branches" of the probability Tree
rEG <- addEdge(nodeNames[1], nodeNames[2], rEG, 1)
rEG <- addEdge(nodeNames[1], nodeNames[3], rEG, 1)
rEG <- addEdge(nodeNames[2], nodeNames[4], rEG, 1)
rEG <- addEdge(nodeNames[2], nodeNames[5], rEG, 1)
rEG <- addEdge(nodeNames[3], nodeNames[6], rEG, 1)
rEG <- addEdge(nodeNames[3], nodeNames[7], rEG, 10)
 
eAttrs <- list()
q<-edgeNames(rEG)
 



# Add the probability values to the the branch lines
eAttrs$label <- c(toString(a),toString(notA),
 toString(bGivena), toString(notbGivena),
 toString(bGivenNota), toString(notbGivenNota))
names(eAttrs$label) <- c(q[1],q[2], q[3], q[4], q[5], q[6])
edgeAttrs<-eAttrs
 
# Set the color, etc, of the tree
attributes<-list(node=list(label="foo", fillcolor="lightgreen", fontsize="15"),
 edge=list(color="red"),graph=list(rankdir="LR"))
 
#Plot the probability tree using Rgraphvis
plot(rEG, edgeAttrs=eAttrs, attrs=attributes)
#nodes(rEG)
#edges(rEG)
 
#Add the probability values to the leaves of A&B, A&B', A'&B, A'&B'
text(500,420,aANDb, cex=.8)
text(500,280,aANDnotb,cex=.8)
text(500,160,notaANDb,cex=.8)
text(500,30,notaANDnotb,cex=.8)
text(340,440,"(B | A)",cex=.8)
text(340,230,"(B | A')",cex=.8)
 
#Write a table in the lower left of the probablites of A and B
text(80,50,paste("P(A):",a),cex=.9, col="darkgreen")
text(80,20,paste("P(A'):",notA),cex=.9, col="darkgreen")
 
text(160,50,paste("P(B):",round(b,digits=2)),cex=.9)
text(160,20,paste("P(B'):",round(notB, 2)),cex=.9)
 
text(80,420,paste("P(A|B): ",round(aGivenb,digits=2)),cex=.9,col="blue")

```